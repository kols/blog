<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="author" content="Kane Dou">
<link rel="shortcut icon" href="/favicon.ico">
<link href="/feed.xml" rel="alternate" title="kandou.me" type="application/rss+xml">
<link rel="stylesheet" href="/assets/stylesheets/screen.css" />
<link rel="stylesheet" href="/assets/stylesheets/syntax.css" />
<title>
  Gentoo的SSH代理启动脚本 | kanedou.me
</title>

  </head>
  <body>
    <div class="container">
      <header id="masthead">
        <div class="row-fluid">
          <div class="span3 branding">
            <h1>
              <a href="/">kanedou.me</a>
            </h1>
          </div>
          <div class="span5 navigation">
            <nav role="navigation">
  <ul class="nav nav-pills">
    <li><a href="/archive.html"><span>archive</span></a></li>
    <li><a href="/links.html"><span>links</span></a></li>
    <li><a href="/about.html"><span>about</span></a></li>
    <li><a href="/feed.xml"><span>feed</span></a></li>
  </ul>
</nav>

          </div>
        </div>
      </header>
      <div id="content">
        
<article role="article" class="well">
  <header>
    <section class="title">
      <h1>
        
        Gentoo的SSH代理启动脚本
        
      </h1>
    </section>
    <section class="meta">
      @<time>2010-09-30</time>
      <span class="categories">
        
      </span>
    </section>
  </header>
  <section class="post">
    <p><abbr title="Secure Shell">SSH</abbr> 代理是相当方便的翻墙工具，我因为不想用其他多余的工具来使用它，因此，出于方便，自己写了一个用于 Gentoo 下的 Initscript，需要的同学可以把下面这个文件放到 <code>/etc/init.d/sshtunnel</code> 修改 <code>username</code> 和 <code>remotehost</code> 两个变量并新建一个软链 <code>/usr/bin/sshtn</code> 至 <code>/usr/bin/ssh</code>，最后使用 <code>sudo rc-update add sshtunnel default</code> 来启用，默认端口7070。</p>

<!-- more -->




<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="c">#!/sbin/runscript</span>
<span class="c">#: Author: Kane Dou &lt;douqilong@gmail.com&gt;</span>
<span class="c">#: Description: Create ssh tunnel to remote server to establish a socks proxy.</span>

<span class="nv">processname</span><span class="o">=</span><span class="s1">'sshtn'</span> <span class="c"># Symbolic link to /usr/bin/ssh to prevent</span>
                    <span class="c">#+start-stop-daemon from stoping other ssh connections</span>
<span class="nv">args</span><span class="o">=</span><span class="s1">'qnTfND'</span> <span class="c"># q for quiet</span>
                <span class="c">#+n for output to /dev/null</span>
                <span class="c">#+T for no tty allocation</span>
                <span class="c">#+f for fork to background</span>
                <span class="c">#+N for no command execution</span>
                <span class="c">#+D for dynamic port forwarding</span>
<span class="nv">username</span><span class="o">=</span><span class="s1">'[ChangeMe]'</span>
<span class="nv">remotehost</span><span class="o">=</span><span class="s1">'[ChangeMe]'</span>
<span class="nv">port</span><span class="o">=</span>7070 <span class="c"># Change me maybe</span>

depend<span class="o">()</span> <span class="o">{</span>
    need net
    before NetworkManager
<span class="o">}</span>

start<span class="o">()</span> <span class="o">{</span>
    ebegin <span class="s2">"Starting SSH Tunnel"</span>
    start-stop-daemon --start --quiet --name <span class="s2">"</span><span class="nv">$processname</span><span class="s2">"</span>
    --exec /usr/bin/sshtn -- -<span class="s2">"</span><span class="nv">$args</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$port</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$username</span><span class="s2">"</span>@<span class="s2">"</span><span class="nv">$remotehost</span><span class="s2">"</span>
    eend <span class="nv">$?</span>
<span class="o">}</span>

stop<span class="o">()</span> <span class="o">{</span>
    ebegin <span class="s2">"Stopping SSH Tunnel"</span>
    start-stop-daemon --stop --quiet --name <span class="s2">"</span><span class="nv">$processname</span><span class="s2">"</span>
    eend <span class="nv">$?</span>
<span class="o">}</span>

restart<span class="o">()</span> <span class="o">{</span>
    ebegin <span class="s2">"Will restart SSH Tunnel"</span>
    svc_stop
    sleep 3
    svc_start
    eend <span class="nv">$?</span>
<span class="o">}</span>

<span class="c"># vim: set ft=gentoo-init-d ts=3 sw=3 et:</span></code></pre></div>


<p>注意，如果服务器会自动切断不活动的 SSH 连接，请在 <code>$HOME/.ssh/config</code> 中加入：</p>

<pre><code>Host [RemoteServerName]
ServerAliveInterval 60
</code></pre>

<p>2011/04/28 Update: 又写了个 Debian 版本，<a href="https://github.com/kols/util_scripts/blob/master/ssh_initscript/sshtunnel_debian">这里</a>找</p>

  </section>
</article>


      </div>
      <footer role="contentinfo" class="contentinfo">
        <div>
  
  
  <span class="copy">&copy; 2004-2014 kane</span>
  |
  <span class="license">
    <a href="http://creativecommons.org/licenses/by/3.0/cn/">license</a>
  </span>
  |
  <span class="engine">
    powered by <a href="http://jekyllrb.com/">jekyll</a> & <a href="http://compass-style.org">compass</a>
  </span>
</div>

      </footer>
    </div>
  </body>
</html>
