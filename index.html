<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html" />
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="author" content="Kane Dou">
<link rel="shortcut icon" href="/favicon.ico">
<link href="/feed.xml" rel="alternate" title="kandou.me" type="application/rss+xml">
<link rel="stylesheet" href="/assets/stylesheets/screen.css" />
<link rel="stylesheet" href="/assets/stylesheets/syntax.css" />
<title>
  kanedou.me
</title>

  </head>
  <body>
    <div class="container">
      <header>
        <div class="row">
          <section class="site-name">
            <div class="span2">
              <h1><a href="/">kanedou.me</a></h1>
            </div>
          </section>
          <section class="nav">
            <div class="span4">
              <nav role="navigation">
  <ul class="nav nav-pills">
    <li><a href="/archive.html">archive</a></li>
    <li><a href="/links.html">links</a></li>
    <li><a href="/about.html">about</a></li>
    <li><a href="/feed.xml">feed</a></li>
  </ul>
</nav>

            </div>
          </section>
        </div>
      </header>
      <div id="content">
        <div class="blog-index">
  
  
  
  
<article role="article" class="well">
  <header>
    <section class="title">
      <h1>
        
        <a href="/2013/03/bioshock-infinite-brought-along/">『Bioshock Infinite』带来的</a>
        
      </h1>
    </section>
    <section class="meta">
      @<time>2013-03-26</time>
      <span class="categories">
        
        <em class="category">#game</em>
        
        <em class="category">#arts</em>
        
      </span>
    </section>
  </header>
  <section class="post">
    <p><img src="http://pic.yupoo.com/kols_v/CJWMsjZA/medium.jpg" alt="Bioshock Infinite" /></p>

<p>游戏作为艺术品是个矛盾体，它的意义需要娱乐来承载，虽然有些电影也是如此，但因为长度往往十个小时起算，因此在游戏中两者并不总是相容的。一点不娱乐的电影可称之为文艺片，但纯文艺而不娱乐大众的游戏估计从来就难以得见天日。因此 『Bioshock』 不断在枪林弹雨之间穿插 Voxophone 录音、Booker 与 Elizabeth 的互动、人性与宿命的考察，枪炮杀戮是前提，维持娱乐水准，后者是内涵，展现制作人真正想告诉你的东西。但由于时长问题，前者却一定是喧宾夺主地占据了玩家最大部分的时间——因此传言中 <abbr title="Metal Gear Solid 4">MGS 4</abbr> 大量过场剧情将玩家操作挤压至接近次要地位的情况，一定是小岛秀夫感受到了这种娱乐与内涵的不调和而做出的回应，但就是这样很简单（当然不简单）地将两者的比例改变一下，也会招致众多玩家的不满，因为游戏，它的第一要素依旧是玩（得爽）——而即使是这样，对于满足快感之余的叙事内容细节的考究、环环相扣的铺垫、精辟带有哲学意味的独白，仍然将整个作品的走向带至艺术品而非娱乐品的行列之中。</p>

<p>即便玩往往是肤浅的，但其体验并非一定与叙事、内涵相矛盾。『旺达与巨像』将对于故事的体验融入到了娱乐内容之中，你在巨像的庞大身躯上攀爬、跌落，狂奔、飞翔，这体验本身就是一种叙事，因为作者把你变成了旺达，你通过手柄感受他的艰难旅途，他甚至从头至尾都不曾说过一句话，让你除了他的肢体，再没有其他什么途径了解他的内心。沉默，往往就是这类游戏的基调，作者只给你一个大的环境与一些小的细节，剩下的全要由你想象，被引导的想象，发散的想象，满足的想象。</p>

<p>然而“娱乐，不论多么有趣，总会有一天厌倦。”这就是粘附在游戏这个想要成为艺术的载体身上的最为严重的缺陷。为了获得内心的感动，你不得不操纵你的角色先杀个尸横遍野，有时候这并不是多么愉快的体验，从而容易让人心生厌倦。电影中永远作为第三者的我们的视角在这时就很有优势，我不用承受任何负担，我可以跳过我不想要的，直入主题，获得满足。</p>

<p>游戏无法分离其表和里，为了得到一样就不能忽略另一样，两者的差异有时却又是如此得大以至于会让人有索性一并放弃的想法。这可能也就是为何游戏只是被戏称为第九艺术而从未真正被冠上艺术品之名的原因。</p>

  </section>
</article>

  
  
  
<article role="article" class="well">
  <header>
    <section class="title">
      <h1>
        
        <a href="/2013/03/motion-picture-diary-i/">电影日记 I</a>
        
      </h1>
    </section>
    <section class="meta">
      @<time>2013-03-09</time>
      <span class="categories">
        
        <em class="category">#motion picture</em>
        
      </span>
    </section>
  </header>
  <section class="post">
    <h2>Play It Again, Sam（呆头鹅）</h2>

<p>中译呆头鹅人如其名，伍迪艾伦把一个又傻又聪明的家伙演得相当神经质（敏感、多虑）
、话唠又不缺不动声色的幽默（“我二十九了，性能力高峰在十年前就结束了”；“不是焦虑
不是惊恐是 homosexual panic”…），说来这也是他的招牌演技了，只不过近年来水准下降
得厉害。向北非谍影借角色来做旁白虽然没法引起我的共鸣（没看过。。。），但却能把
剧情顺当地推进下去同时也有点人格分裂的意味，同时借他人之口来讲述自己的想法，不
会造成矛盾。戴安基顿这部片里长得有点奇怪，但那种呆呆的音调很有意思，同时衣着永
远有品位。虽然没有什么亮点但一演起对手戏就有种相当默契的感觉，不算话唠，但也喜
欢平静地一鸣惊人。她老公比较正常，同时也比较搞，随时报上所在地电话号码印象深刻
。快结束时那一段段臆想的剧情亮点颇多。结局稍有点首尾呼应。</p>

<h2>To Kill a Mocking Bird（杀死一只知更鸟）</h2>

<p>女孩 Scout 叫自己爸爸 Atticus 是让我觉得最棒的细节，一下子把她的天真无拘束和他
的平静稳定显露无遗。节奏很好，把这个伸张正义的片子拍得有点惊悚、有点悬疑又有点
悲哀。但不管怎么绕，父亲的正直，女孩和男孩的活泼，以及最后出场的人物那种让人惊
喜的善良（就像一只知更鸟）都被恰当表现了出来，不会头重脚轻虎头蛇尾。人性是丑恶
与美好并存的，然而即使是恶也并非总是纯粹的恶，而是被大势裹挟了的无知的恶。当嫌
疑人被关到镇里，镇上的居民被煽动想绕过法律直接制裁他，但勇敢的 Scout 的一席话就
改变了他们的态度，救了父亲，同时展现人们的矛盾。庭审是遗憾的，向我们展现了无论
哪个年代的人们都绕不过的那种不公的鄙夷与憎恶，以及努力了、捍卫了但又失败了的无
力。法庭辩论中张弛有度，不言自明的魅力被 Atticus 表现得淋漓尽致。</p>

<h2>I Confess（忏情记）</h2>

<p>恪守原则还是爱？不论哪个都需要勇气支撑。当女主角把一切和盘托出的时候，这个故事
落幕了还是刚刚开始？都不是，只是告诉你你的坦白真诚一文不名。为何探寻真相的人反
而要利用真相来达到自己的目的？因为掺杂了真相的谎言最容易生效。当一系列的巧合都
被联系到作为被告人的男主角身上时，他的沉默只是作为巧合的对立面的必然。当编剧觉
得巧合足够多的时候就给了观众一个解脱，但不那么自然，虽然我认为男主角的自我牺牲
如果真的能打动人，也就只能打动她了吧，以正确的方式。这就牵扯到另一个问题，你的
沉默别人不知缘由，就像你做了艰苦工作但没有人能够看得到，那它是白费了还是总在那
里等待别人的发现？电影说是后者。</p>

  </section>
</article>

  
  
  
<article role="article" class="well">
  <header>
    <section class="title">
      <h1>
        
        <a href="/2012/12/you-need-sunshine-boy/">You need sunshine boy</a>
        
      </h1>
    </section>
    <section class="meta">
      @<time>2012-12-25</time>
      <span class="categories">
        
        <em class="category">#photo</em>
        
      </span>
    </section>
  </header>
  <section class="post">
    <p><a href="http://500px.com/photo/21445079">
  <img class="oob" src="http://pcdn.500px.net/21445079/707294c5752a8f50b583d86f5732c2e4f39a04ab/4.jpg" alt="Wind by Kane Dou (kols)) on 500px.com" />
</a></p>

<p>you do need it (;</p>

  </section>
</article>

  
  
  
<article role="article" class="well">
  <header>
    <section class="title">
      <h1>
        
        <a href="/2012/07/introducing-python-scrapy-part-i/">使用 scrapy （Part I）</a>
        
      </h1>
    </section>
    <section class="meta">
      @<time>2012-07-18</time>
      <span class="categories">
        
        <em class="category">#python</em>
        
        <em class="category">#scrape</em>
        
        <em class="category">#crawl</em>
        
        <em class="category">#scrapy</em>
        
        <em class="category">#twisted</em>
        
      </span>
    </section>
  </header>
  <section class="post">
    <p><a href="http://scrapy.org">scrapy</a> 是一个高级的网页内容抓取工具，主要用来自动化访问网
页并程序化提取其中对用户有用的内容。scrapy 构建于流行的 python 异步框架
<a href="http://twistedmatrix.com">twisted</a> 之上，利用该框架的特点达到抓取的高效率，但
其面向用户的接口则是完全经过封装并与普通 python 代码写法并无二致的，因此不熟悉
twisted 的用户也不用担心。</p>

<!-- more -->


<h2>安装</h2>

<p>由于 scrapy 是一个 python package，所以先安装 virtualenv 及 pip：</p>

<div class="highlight"><pre><code class="sh"><span class="nv">$ </span>sudo apt-get install virtualenv python-pip
</code></pre></div>


<p>接着安装 scrapy：</p>

<div class="highlight"><pre><code class="sh"><span class="nv">$ </span>virtualenv --no-site-packages scrapy
<span class="nv">$ </span><span class="nb">source</span> ./scrapy/bin/activate
<span class="nv">$ </span>pip install scrapy
</code></pre></div>


<h2>使用</h2>

<p>scrapy 提供的各种工具能大量简化实际抓取时的代码量，同时其对抓取过程的抽象化也很
到位，方便用户对其控制的同时也提供了相当的自动化特性。</p>

<p>这里就用罗森的官方网站（http://www.lawson.com.cn/shops）为例，说明一下如何使用
scrapy。示例的结果是得到一份罗森在上海的所有便利店的清单。</p>

<h3>新建 Project</h3>

<p>首先用 scrapy 新建一个 project：</p>

<div class="highlight"><pre><code class="sh"><span class="nv">$ </span>scrapy startproject lawson
</code></pre></div>


<p>熟悉一下目录结构：</p>

<div class="highlight"><pre><code class="text">lawson
├── lawson
│   ├── __init__.py
│   ├── items.py
│   ├── pipelines.py
│   ├── settings.py
│   └── spiders
│       └── __init__.py
└── scrapy.cfg
</code></pre></div>


<ul>
<li><code>items.py</code> 定义抓取结果中单个项所需要包含的所有内容，比如便利店的地址、
分店名称等。</li>
<li><code>pipelines.py</code> 定义如何对抓取到的内容进行再处理，例如输出文件、写入数据库等。</li>
<li><code>settings.py</code> 是 scrapy 的设置文件，可对其行为进行调整。</li>
<li><code>spiders</code> 目录下存放写好的 spider，也即是实际抓取逻辑。</li>
<li><code>scrapy.cfg</code> 是整个项目的设置，主要用于部署 scrapyd 服务，本文不会涉及。</li>
</ul>


<h3>第一个 spider</h3>

<p>scrapy 中最为重要的部分就是
<a href="http://doc.scrapy.org/en/0.14/topics/spiders.html">spider</a>。它包含了
分析网页与抓取网页数据的具体逻辑，也就是说对网页上任何内容的任何处理都在 spider
中实现。因此，这是 scrapy 整个框架的核心。</p>

<p>首先定义
<a href="http://doc.scrapy.org/en/0.14/topics/items.html#module-scrapy.item">Item</a>：</p>

<div class="highlight"><pre><code class="python"><span class="kn">from</span> <span class="nn">scrapy.item</span> <span class="kn">import</span> <span class="n">Item</span><span class="p">,</span> <span class="n">Field</span>


<span class="k">class</span> <span class="nc">ConvStore</span><span class="p">(</span><span class="n">Item</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">Field</span><span class="p">()</span>
    <span class="n">branch</span> <span class="o">=</span> <span class="n">Field</span><span class="p">()</span>
    <span class="n">alias</span> <span class="o">=</span> <span class="n">Field</span><span class="p">()</span>
    <span class="n">address</span> <span class="o">=</span> <span class="n">Field</span><span class="p">()</span>
    <span class="n">city</span> <span class="o">=</span> <span class="n">Field</span><span class="p">()</span>
    <span class="n">district</span> <span class="o">=</span> <span class="n">Field</span><span class="p">()</span>
    <span class="n">longitude</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">serializer</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">latitude</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">serializer</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</code></pre></div>


<p>这里定义了一个便利店（<code>ConvStore</code>）所应包含的内容（
<a href="http://doc.scrapy.org/en/0.14/topics/items.html#item-fields">Field</a> ），会在
spider 中用到，用来承载其抓取下来的实际数据。</p>

<p>现在来看 spider：</p>

<div class="highlight"><pre><code class="python"><span class="kn">from</span> <span class="nn">scrapy.contrib.linkextractors.sgml</span> <span class="kn">import</span> <span class="n">SgmlLinkExtractor</span>
<span class="kn">from</span> <span class="nn">scrapy.contrib.spiders</span> <span class="kn">import</span> <span class="n">CrawlSpider</span><span class="p">,</span> <span class="n">Rule</span>
<span class="kn">from</span> <span class="nn">scrapy.selector</span> <span class="kn">import</span> <span class="n">HtmlXPathSelector</span>

<span class="kn">from</span> <span class="nn">lawson.items</span> <span class="kn">import</span> <span class="n">ConvStore</span>


<span class="k">class</span> <span class="nc">LawsonSpider</span><span class="p">(</span><span class="n">CrawlSpider</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;lawson&#39;</span>
    <span class="n">start_urls</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;http://www.lawson.com.cn/shops&#39;</span><span class="p">]</span>
    <span class="n">allowed_domains</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;lawson.com.cn&#39;</span><span class="p">]</span>
    <span class="n">rules</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">Rule</span><span class="p">(</span><span class="n">SgmlLinkExtractor</span><span class="p">(</span><span class="n">allow</span><span class="o">=</span><span class="s">r&#39;list\?area_id=\d+&#39;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="s">&#39;a&#39;</span><span class="p">),</span>
                <span class="n">callback</span><span class="o">=</span><span class="s">&#39;parse_store_list&#39;</span><span class="p">),</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">parse_store_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="n">hxs</span> <span class="o">=</span> <span class="n">HtmlXPathSelector</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="n">store_selectors</span> <span class="o">=</span> <span class="n">hxs</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s">&#39;//div[@class=&quot;ShopList&quot;]/table/tr&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">store_selectors</span><span class="p">:</span>
            <span class="n">store</span> <span class="o">=</span> <span class="n">ConvStore</span><span class="p">()</span>
            <span class="n">store</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">u&#39;罗森&#39;</span>
            <span class="n">store</span><span class="p">[</span><span class="s">&#39;alias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">u&#39;Lawson&#39;</span>
            <span class="n">store</span><span class="p">[</span><span class="s">&#39;branch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s">&#39;th/p/text()&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span>
            <span class="n">store</span><span class="p">[</span><span class="s">&#39;address&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s">&#39;td/span/text()&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span>
            <span class="n">store</span><span class="p">[</span><span class="s">&#39;district&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s">&#39;link_text&#39;</span><span class="p">]</span>
            <span class="n">store</span><span class="p">[</span><span class="s">&#39;city&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">u&#39;上海&#39;</span>

            <span class="k">yield</span> <span class="n">store</span><span class="o">.</span><span class="n">load_item</span><span class="p">()</span>
</code></pre></div>


<ul>
<li>首先可以看到代码很短，整个 <code>LawsonSpider</code> 类只有二十多行，但已经能够为我们抓
取所有必需的信息。</li>
<li>scrapy 提供了一些基本类（Base class）让我们去继承，
<a href="http://doc.scrapy.org/en/0.14/topics/spiders.html#crawlspider"><code>CrawlSpider</code></a>
就是其中之一。代码中所定义的类变量（Class variable）都是再 scrapy 中有各自作
用的。

<ul>
<li><code>name</code> 是该 spider 的名字，scrapy 命令行工具调用 spider 时就用这个名字去找
到对应的 spider。</li>
<li><code>start_urls</code> 是 spider 的入口，即是告诉它该从哪个网页开始抓取。</li>
<li><code>allowed_domains</code> 限定 spider 的抓取活动只能在指定的 domain 中进行。</li>
</ul>
</li>
<li><code>rules</code> 定义了一系列规则用来匹配网页中出现的内容，并根据规则分发至不同的处理
方法中。这里定义了一个规则是向网页中所有匹配正则表达式 <code>r'list\?area_id=\d+'</code>
的链接（如果你在浏览器打开初始页面的话会发现这些就是页面下方以上海各个区命名
的那几个链接）发出请求并将其结果交给 <code>parse_store_list</code> 方法（Method）来处理。</li>
<li><a href="http://doc.scrapy.org/en/0.14/topics/link-extractors.html#sgmllinkextractor"><code>SgmlLinkExtractor</code></a>
是 scrapy 提供的连接提取器，它的用途就是，呃，提取链接。

<ul>
<li><code>allow</code> 参数是正则表达式，网页中匹配的链接会被抓取。</li>
<li><code>tags</code> 指定从哪些标签抓取链接，默认 <code>['a', 'area']</code>（通过分析网页
这里不能包含 <code>area</code>，故手动指定。</li>
</ul>
</li>
<li><code>parse_store_list</code> 方法定义了如何抓取特定网页中的数据

<ul>
<li><a href="http://doc.scrapy.org/en/0.14/topics/selectors.html#scrapy.selector.HtmlXPathSelector"><code>HtmlXPathSelector</code></a>
是一个选择器，使用它能方便地定位到网页中的某个位置并抓取其中内容。</li>
</ul>
</li>
</ul>


<h3><code>CrawlSpider</code></h3>

<p>这个类是整个抓取逻辑的基础，他的工作流程如下：</p>

<ol>
<li>若有 <code>start_urls</code>，则从这些 URL 开始抓取，若没有，则执行 <code>start_requests</code> 方
法（用户须定义），并请求该方法返回的 <code>Request</code> 对象，并从这些请求结果中开始
抓取。</li>
<li>所有网页请求返回的 <code>Response</code> 默认交给 <code>parse</code> 方法处理。

<ul>
<li><code>parse</code> 方法在 <code>CrawlSpider</code> 的默认实现是用已定义的 <code>rules</code> 对获得的网页内
容进行匹配并进行由 <code>Rule</code> 所指定的进一步处理（即交给 <code>callback</code> 参数所指定
的 <code>callable</code> 去处理）。</li>
<li>若不指定 <code>callback</code>, <code>Rule</code> 的默认处理是对匹配的网址发起请求，并再次交给
<code>parse</code>。</li>
</ul>
</li>
<li>任何方法中返回的 Item 实例（如示例中的 <code>ConvStore</code>）都会被作为有效数据保存
（输出文件等），再处理（
<a href="http://doc.scrapy.org/en/0.14/topics/item-pipeline.html">Pipeline</a>）。</li>
</ol>


<h3><code>HtmlXPathSelector</code></h3>

<p>这是一个通过 <a href="http://www.w3schools.com/xpath/default.asp">XPath</a> 对 HTML 页面进
行结构化定位和内容读取的工具。scrapy 使用它定位到网页中用户所需要的数据并进行抓
取。</p>

<div class="highlight"><pre><code class="python"><span class="k">def</span> <span class="nf">parse_store_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
    <span class="n">hxs</span> <span class="o">=</span> <span class="n">HtmlXPathSelector</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
    <span class="n">store_selectors</span> <span class="o">=</span> <span class="n">hxs</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s">&#39;//div[@class=&quot;ShopList&quot;]/table/tr&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>

    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">store_selectors</span><span class="p">:</span>
        <span class="o">...</span>
        <span class="n">store</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="s">&#39;branch&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s">&#39;th/p/text()&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">extract</span><span class="p">())</span>
        <span class="n">store</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="s">&#39;address&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s">&#39;td/span/text()&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">extract</span><span class="p">())</span>
        <span class="o">...</span>
</code></pre></div>


<ul>
<li><code>HtmlXPathSelector</code> 需要一个 Response 对象来实例化。</li>
<li><code>//div[@class="ShopList"]/table/tr</code> 选择了所有包含罗森门店信息的 <code>tr</code> 标签。</li>
<li><code>s.select('th/p/text()').extract()</code> 在之前的选择基础上继续对其子标签做选择，
这里就确实得选择到了分店名。<code>extract()</code> 则将该标签的文本数据读取出来。</li>
<li><code>HtmlXPathSelector</code> 还有正则表达式接口，后文会提到。</li>
</ul>


<h3>Field, Item 及 Item Loader</h3>

<p>Field 仅仅是一个 <code>dict</code> 的 wrapper 类，因此使用方法与 <code>dict</code> 完全一样，在
scrapy 中它负责声明单个 Item 的字段及该字段的各种行为（如序列化方法
<code>serializer</code>）。</p>

<p>Item 用 Field 定义了单个有效数据的具体字段，而实际中则是主要有两种方法写入
数据：</p>

<ol>
<li>使用其类似 <code>dict</code> 的接口进行数据的写入和读取，<code>key</code> 为字段名。</li>
<li>使用 <a href="http://doc.scrapy.org/en/0.14/topics/loaders.html">Item Loader</a>。</li>
</ol>


<p><code>dict</code> 接口的用法如上所示很简单，这里说一下 Item Loader。</p>

<div class="highlight"><pre><code class="python"><span class="kn">from</span> <span class="nn">scrapy.contrib.loader</span> <span class="kn">import</span> <span class="n">ItemLoader</span>
<span class="kn">from</span> <span class="nn">scrapy.contrib.loader.processor</span> <span class="kn">import</span> <span class="n">Compose</span>

<span class="kn">from</span> <span class="nn">lawson.items</span> <span class="kn">import</span> <span class="n">ConvStore</span>


<span class="k">class</span> <span class="nc">StoreLoader</span><span class="p">(</span><span class="n">ItemLoader</span><span class="p">):</span>
    <span class="n">default_output_processor</span> <span class="o">=</span> <span class="n">Compose</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">unicode</span><span class="o">.</span><span class="n">strip</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">branch_in</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">yield</span> <span class="n">v</span> <span class="o">+</span> <span class="s">u&#39;店&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">u&#39;店&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">v</span>


<span class="k">class</span> <span class="nc">LawsonSpider</span><span class="p">(</span><span class="n">CrawlSpider</span><span class="p">):</span>
    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">parse_store_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="n">hxs</span> <span class="o">=</span> <span class="n">HtmlXPathSelector</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="n">store_selectors</span> <span class="o">=</span> <span class="n">hxs</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s">&#39;//div[@class=&quot;ShopList&quot;]/table/tr&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">store_selectors</span><span class="p">:</span>
            <span class="n">store</span> <span class="o">=</span> <span class="n">StoreLoader</span><span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="n">ConvStore</span><span class="p">(),</span> <span class="n">response</span><span class="o">=</span><span class="n">response</span><span class="p">)</span>
            <span class="n">store</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="s">u&#39;罗森&#39;</span><span class="p">)</span>
            <span class="n">store</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="s">&#39;alias&#39;</span><span class="p">,</span> <span class="s">u&#39;Lawson&#39;</span><span class="p">)</span>
            <span class="n">store</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="s">&#39;branch&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s">&#39;th/p/text()&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">extract</span><span class="p">())</span>
            <span class="n">store</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="s">&#39;address&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s">&#39;td/span/text()&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">extract</span><span class="p">())</span>
            <span class="n">store</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="s">&#39;district&#39;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s">&#39;link_text&#39;</span><span class="p">])</span>
            <span class="n">store</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="s">&#39;city&#39;</span><span class="p">,</span> <span class="s">u&#39;上海&#39;</span><span class="p">)</span>

            <span class="k">yield</span> <span class="n">store</span><span class="o">.</span><span class="n">load_item</span><span class="p">()</span>
</code></pre></div>


<p>Item Loader 的主要作用是对抓取数据的各个字段进行特殊处理，在这里我们定义了一个
<code>StoreLoader</code> 类继承（Inherit）自 <code>ItemLoader</code>：</p>

<ul>
<li><code>default_output_processor</code> 定义默认的输出处理器，这里我们对抓取的数据值进行
strip 操作。</li>
<li><code>branch_in</code> 方法是对 <code>branch</code> 字段的特殊处理，他发生在输入的时候，也就是刚抓
取到数据之后。这里的处理是为没有<code>店</code>这个字的分店名补上这个字。</li>
<li><code>&lt;field&gt;_in</code> 和 <code>&lt;field&gt;_out</code> 会各对指定字段做一次处理，前者是在刚抓取到数据
时，后者是在最终输出之前，用户根据需要定义相应方法。

<ul>
<li>scrapy 有一些 <a href="http://doc.scrapy.org/en/0.14/topics/loaders.html#module-scrapy.contrib.loader.processor">built-in processor</a>
可以直接使用，进行一些通用处理。</li>
</ul>
</li>
<li><code>add_value</code> 将值赋予相应字段，很好理解。</li>
<li><code>load_item</code> 返回该条填充过数据的 Item。</li>
</ul>


<p>使用 Item Loader 的好处显而易见，我们有一个统一的地方对所有数据字段进行处理，不
用将其混入抓取逻辑，使整个流程分工明确。</p>

<p>另一个常用的 Item Loader 是 <code>XPathItemLoader</code>，显然这个版本利用了 XPath：</p>

<div class="highlight"><pre><code class="python"><span class="n">store</span> <span class="o">=</span> <span class="n">XPathItemLoader</span><span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="n">ConvStore</span><span class="p">(),</span> <span class="n">response</span><span class="o">=</span><span class="n">response</span><span class="p">)</span>
<span class="n">store</span><span class="o">.</span><span class="n">add_xpath</span><span class="p">(</span><span class="s">&#39;branch&#39;</span><span class="p">,</span> <span class="s">&#39;//div[@class=&quot;ShopList&quot;]/table/tr[2]/th/p/text()&#39;</span><span class="p">)</span>
</code></pre></div>


<p>它将字段与 XPath 表达式关联起来，直接完成定位、读取和写入数据的操作，很方便。</p>

<h3>加上经纬度</h3>

<p>经纬度对于定位一个地点是很有用的，通过电子地图能够精确地定位至相关地点。我发现
罗森网站提供了这个信息，但它并未明文显示，而是需要通过其所链接到的百度地图的页
面中去抓取下来，听起来很麻烦，但实际却很简单。</p>

<div class="highlight"><pre><code class="python"><span class="kn">from</span> <span class="nn">urlparse</span> <span class="kn">import</span> <span class="n">urljoin</span>

<span class="kn">from</span> <span class="nn">scrapy.contrib.loader</span> <span class="kn">import</span> <span class="n">XPathItemLoader</span>
<span class="kn">from</span> <span class="nn">scrapy.http</span> <span class="kn">import</span> <span class="n">Request</span>
<span class="kn">from</span> <span class="nn">scrapy.selector</span> <span class="kn">import</span> <span class="n">HtmlXPathSelector</span>
<span class="kn">from</span> <span class="nn">scrapy.utils.response</span> <span class="kn">import</span> <span class="n">get_base_url</span>

<span class="kn">from</span> <span class="nn">poi_scrape.items</span> <span class="kn">import</span> <span class="n">ConvStore</span>


<span class="k">class</span> <span class="nc">StoreLoader</span><span class="p">(</span><span class="n">XPathItemLoader</span><span class="p">):</span>
    <span class="o">...</span>


<span class="k">class</span> <span class="nc">LawsonSpider</span><span class="p">(</span><span class="n">BasePoiSpider</span><span class="p">):</span>
    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">parse_geo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="n">hxs</span> <span class="o">=</span> <span class="n">HtmlXPathSelector</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="n">store</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s">&#39;store&#39;</span><span class="p">]</span>

        <span class="n">lng</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="n">hxs</span><span class="o">.</span><span class="n">re</span><span class="p">(</span><span class="s">r&#39;(\d+\.\d+),(\d+\.\d+)&#39;</span><span class="p">)</span>
        <span class="n">store</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="s">&#39;latitude&#39;</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span>
        <span class="n">store</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="s">&#39;longitude&#39;</span><span class="p">,</span> <span class="n">lng</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">store</span><span class="o">.</span><span class="n">load_item</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">parse_store_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="o">...</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">store_selectors</span><span class="p">:</span>
            <span class="n">store</span> <span class="o">=</span> <span class="n">StoreLoader</span><span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="n">ConvStore</span><span class="p">(),</span> <span class="n">response</span><span class="o">=</span><span class="n">response</span><span class="p">)</span>
            <span class="o">...</span>

            <span class="n">map_rel_url</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s">&#39;td/a/@rel&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">map_rel_url</span><span class="p">:</span>
                <span class="n">map_url</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="n">get_base_url</span><span class="p">(</span><span class="n">response</span><span class="p">),</span> <span class="n">map_rel_url</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">req</span> <span class="o">=</span> <span class="n">Request</span><span class="p">(</span><span class="n">map_url</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parse_geo</span><span class="p">)</span>
                <span class="n">req</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s">&#39;store&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">store</span>
                <span class="k">yield</span> <span class="n">req</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">store</span><span class="o">.</span><span class="n">load_item</span><span class="p">()</span>
</code></pre></div>


<p>这里为 <code>LawsonSpider</code> 新增了一个方法 <code>parse_geo</code>，同时改写了
<code>parse_store_list</code>。</p>

<ul>
<li>在 <code>parse_store_list</code> 的循环中我抓取每个店的 <code>tr</code> 标签中的 <code>td/a/@rel</code> 属性
（Attribute）（这里 <code>@rel</code> 表示 <code>a</code> 标签的 <code>rel</code> 属性），若有这一属性则对这个
地图的链接发起请求，即 <code>yield req</code>。

<ul>
<li>在 scrapy 中，spider 类中的方法若返回 Request 实例则 scrapy 会自动对该
Request 包含的 URL 发出请求，并将其返回的结果封装为 Response 后交给
<code>callback</code> 参数中指定的方法处理，若未指定 <code>callback</code>，则交给 <code>parse</code> 方法处
理。</li>
</ul>
</li>
<li><code>req.meta['store'] = store</code>，每个 Request 有一个预定义的 <code>meta</code> 属性（<code>dict</code>
），保存在其中的值在其对应的 Response 中可以再次取出：
<code>store = response.meta['store']</code>。</li>
<li><code>hxs.re(r'(\d+\.\d+),(\d+\.\d+)')</code> 使用了 <code>HtmlXPathSelector</code> 的正则表达式接
口直接从网页中通过正则表达式匹配抓取数据。</li>
</ul>


<h3>完整 spider 代码</h3>

<p><code>items.py</code> 没有改动，与上文中的一致。</p>

<div class="highlight"><pre><code class="python"><span class="c"># vim: fileencoding=utf-8</span>
<span class="kn">from</span> <span class="nn">urlparse</span> <span class="kn">import</span> <span class="n">urljoin</span>

<span class="kn">from</span> <span class="nn">scrapy.contrib.linkextractors.sgml</span> <span class="kn">import</span> <span class="n">SgmlLinkExtractor</span>
<span class="kn">from</span> <span class="nn">scrapy.contrib.loader</span> <span class="kn">import</span> <span class="n">XPathItemLoader</span>
<span class="kn">from</span> <span class="nn">scrapy.contrib.loader.processor</span> <span class="kn">import</span> <span class="n">Compose</span>
<span class="kn">from</span> <span class="nn">scrapy.contrib.spiders</span> <span class="kn">import</span> <span class="n">CrawlSpider</span><span class="p">,</span> <span class="n">Rule</span>
<span class="kn">from</span> <span class="nn">scrapy.http</span> <span class="kn">import</span> <span class="n">Request</span>
<span class="kn">from</span> <span class="nn">scrapy.selector</span> <span class="kn">import</span> <span class="n">HtmlXPathSelector</span>
<span class="kn">from</span> <span class="nn">scrapy.utils.response</span> <span class="kn">import</span> <span class="n">get_base_url</span>

<span class="kn">from</span> <span class="nn">lawson.items</span> <span class="kn">import</span> <span class="n">ConvStore</span>


<span class="k">class</span> <span class="nc">StoreLoader</span><span class="p">(</span><span class="n">XPathItemLoader</span><span class="p">):</span>
    <span class="n">default_output_processor</span> <span class="o">=</span> <span class="n">Compose</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">unicode</span><span class="o">.</span><span class="n">strip</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">branch_in</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">yield</span> <span class="n">v</span> <span class="o">+</span> <span class="s">u&#39;店&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">u&#39;店&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">v</span>


<span class="k">class</span> <span class="nc">LawsonSpider</span><span class="p">(</span><span class="n">CrawlSpider</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;lawson&#39;</span>
    <span class="n">start_urls</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;http://www.lawson.com.cn/shops&#39;</span><span class="p">]</span>
    <span class="n">allowed_domains</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;lawson.com.cn&#39;</span><span class="p">]</span>
    <span class="n">rules</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">Rule</span><span class="p">(</span><span class="n">SgmlLinkExtractor</span><span class="p">(</span><span class="n">allow</span><span class="o">=</span><span class="s">r&#39;list\?area_id=\d+&#39;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="s">&#39;a&#39;</span><span class="p">),</span>
                <span class="n">callback</span><span class="o">=</span><span class="s">&#39;parse_store_list&#39;</span><span class="p">),</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">parse_geo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="n">hxs</span> <span class="o">=</span> <span class="n">HtmlXPathSelector</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="n">store</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s">&#39;store&#39;</span><span class="p">]</span>

        <span class="n">lng</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="n">hxs</span><span class="o">.</span><span class="n">re</span><span class="p">(</span><span class="s">r&#39;(\d+\.\d+),(\d+\.\d+)&#39;</span><span class="p">)</span>
        <span class="n">store</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="s">&#39;latitude&#39;</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span>
        <span class="n">store</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="s">&#39;longitude&#39;</span><span class="p">,</span> <span class="n">lng</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">store</span><span class="o">.</span><span class="n">load_item</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">parse_store_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="n">hxs</span> <span class="o">=</span> <span class="n">HtmlXPathSelector</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="n">store_selectors</span> <span class="o">=</span> <span class="n">hxs</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s">&#39;//div[@class=&quot;ShopList&quot;]/table/tr&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">store_selectors</span><span class="p">:</span>
            <span class="n">store</span> <span class="o">=</span> <span class="n">StoreLoader</span><span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="n">ConvStore</span><span class="p">(),</span> <span class="n">response</span><span class="o">=</span><span class="n">response</span><span class="p">)</span>
            <span class="n">store</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="s">u&#39;罗森&#39;</span><span class="p">)</span>
            <span class="n">store</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="s">&#39;alias&#39;</span><span class="p">,</span> <span class="s">u&#39;Lawson&#39;</span><span class="p">)</span>
            <span class="n">store</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="s">&#39;branch&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s">&#39;th/p/text()&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">extract</span><span class="p">())</span>
            <span class="n">store</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="s">&#39;address&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s">&#39;td/span/text()&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">extract</span><span class="p">())</span>
            <span class="n">store</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="s">&#39;district&#39;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s">&#39;link_text&#39;</span><span class="p">])</span>
            <span class="n">store</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="s">&#39;city&#39;</span><span class="p">,</span> <span class="s">u&#39;上海&#39;</span><span class="p">)</span>

            <span class="n">map_rel_url</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s">&#39;td/a/@rel&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">map_rel_url</span><span class="p">:</span>
                <span class="n">map_url</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="n">get_base_url</span><span class="p">(</span><span class="n">response</span><span class="p">),</span> <span class="n">map_rel_url</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">req</span> <span class="o">=</span> <span class="n">Request</span><span class="p">(</span><span class="n">map_url</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parse_geo</span><span class="p">)</span>
                <span class="n">req</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s">&#39;store&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">store</span>
                <span class="k">yield</span> <span class="n">req</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">store</span><span class="o">.</span><span class="n">load_item</span><span class="p">()</span>
</code></pre></div>


<h3>scrapy 命令行工具</h3>

<p>scrapy 提供了一些命令行工具
（<a href="http://doc.scrapy.org/en/0.14/topics/commands.html">Command line tool</a>），之
前创建 Project 的时候用到的 <code>startproject</code> 就是其中之一。而除了这个之外，其他工
具也各自提供了相当有用的功能。</p>

<div class="highlight"><pre><code class="text">$ scrapy
Scrapy 0.14.4 - project: lawson

Usage:
  scrapy &lt;command&gt; [options] [args]

Available commands:
  crawl         Start crawling from a spider or URL
  deploy        Deploy project in Scrapyd target
  edit          Edit spider
  fetch         Fetch a URL using the Scrapy downloader
  genspider     Generate new spider using pre-defined templates
  list          List available spiders
  parse         Parse URL (using its spider) and print the results
  runspider     Run a self-contained spider (without creating a project)
  server        Start Scrapyd server for this project
  settings      Get settings values
  shell         Interactive scraping console
  startproject  Create new project
  version       Print Scrapy version
  view          Open URL in browser, as seen by Scrapy

Use &quot;scrapy &lt;command&gt; -h&quot; to see more info about a command
</code></pre></div>


<p>这里仅挑出部分来讲。</p>

<h4><code>shell</code></h4>

<div class="highlight"><pre><code class="sh"><span class="nv">$ </span>scrapy shell <span class="s1">&#39;http://www.lawson.com.cn/shops&#39;</span>
</code></pre></div>


<p>运行后会进入 Python Interpreter，在这里我们能进行各种试验，配合
<a href="http://doc.scrapy.org/en/0.14/topics/firebug.html">Firebug</a> 之类的工具，为程序
构建一个原型：</p>

<ul>
<li>抓取各区分店列表链接，同时演示 <code>SgmlLInkExtractor</code> 用法：</li>
</ul>


<div class="highlight"><pre><code class="python"><span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="kn">from</span> <span class="nn">scrapy.contrib.linkextractors.sgml</span> <span class="kn">import</span> <span class="n">SgmlLinkExtractor</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="n">SgmlLinkExtractor</span><span class="p">(</span><span class="n">allow</span><span class="o">=</span><span class="s">r&#39;list\?area_id=\d+&#39;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="s">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">extract_links</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
<span class="p">[</span><span class="n">Link</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s">&#39;http://www.lawson.com.cn/shops/list?area_id=1&#39;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s">u&#39;</span><span class="se">\u957f\u5b81\u533a</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">fragment</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">nofollow</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
 <span class="n">Link</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s">&#39;http://www.lawson.com.cn/shops/list?area_id=2&#39;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s">u&#39;</span><span class="se">\u5f90\u6c47\u533a</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">fragment</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">nofollow</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
 <span class="n">Link</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s">&#39;http://www.lawson.com.cn/shops/list?area_id=3&#39;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s">u&#39;</span><span class="se">\u9759\u5b89\u533a</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">fragment</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">nofollow</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
 <span class="o">...</span>
</code></pre></div>


<ul>
<li>抓取分店列表，<code>fetch</code> 用来载入新的 URL：</li>
</ul>


<div class="highlight"><pre><code class="python"><span class="n">In</span> <span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="n">fetch</span><span class="p">(</span><span class="s">&#39;http://www.lawson.com.cn/shops/list?area_id=1&#39;</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="n">hxs</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s">&#39;//div[@class=&quot;ShopList&quot;]/table/tr&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">7</span><span class="p">]:</span>
<span class="p">[</span><span class="o">&lt;</span><span class="n">HtmlXPathSelector</span> <span class="n">xpath</span><span class="o">=</span><span class="s">&#39;//div[@class=&quot;ShopList&quot;]/table/tr&#39;</span> <span class="n">data</span><span class="o">=</span><span class="s">u&#39;&lt;tr&gt;&lt;th scope=&quot;row&quot; class=&quot;linetop&quot;&gt;</span><span class="se">\n\t\t\t</span><span class="s">&#39;</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="n">HtmlXPathSelector</span> <span class="n">xpath</span><span class="o">=</span><span class="s">&#39;//div[@class=&quot;ShopList&quot;]/table/tr&#39;</span> <span class="n">data</span><span class="o">=</span><span class="s">u&#39;&lt;tr&gt;&lt;th scope=&quot;row&quot; class=&quot;linetop&quot;&gt;</span><span class="se">\n\t\t\t</span><span class="s">&#39;</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="n">HtmlXPathSelector</span> <span class="n">xpath</span><span class="o">=</span><span class="s">&#39;//div[@class=&quot;ShopList&quot;]/table/tr&#39;</span> <span class="n">data</span><span class="o">=</span><span class="s">u&#39;&lt;tr&gt;&lt;th scope=&quot;row&quot; class=&quot;linetop&quot;&gt;</span><span class="se">\n\t\t\t</span><span class="s">&#39;</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="o">...</span><span class="p">]</span>
</code></pre></div>


<ul>
<li>抓取分店名称，演示 <code>HtmlXPathSelector</code> 用法：</li>
</ul>


<div class="highlight"><pre><code class="python"><span class="n">In</span> <span class="p">[</span><span class="mi">8</span><span class="p">]:</span> <span class="n">s</span> <span class="o">=</span> <span class="n">hxs</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s">&#39;//div[@class=&quot;ShopList&quot;]/table/tr&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:][</span><span class="mi">0</span><span class="p">]</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">9</span><span class="p">]:</span> <span class="n">s</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s">&#39;th/p/text()&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">9</span><span class="p">]:</span> <span class="p">[</span><span class="s">u&#39;</span><span class="se">\n\t\t\t\t\u53e4\u5317\u65b0\u533a\n\t\t\t\t</span><span class="s">&#39;</span><span class="p">]</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">11</span><span class="p">]:</span> <span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s">&#39;th/p/text()&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">extract</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s">u&#39;店&#39;</span>
<span class="err">古北新区店</span>
</code></pre></div>


<p>这是一个相当完善的命令行界面，提供了所有必需的网页分析及抓取工具，十分适合在实
际写抓取程序前做实验。</p>

<p>而 <code>shell</code> 不仅能从命令行直接调用，还能从程序中调用直接进入以便分析程序做调试：</p>

<div class="highlight"><pre><code class="python"><span class="kn">from</span> <span class="nn">scrapy.shell</span> <span class="kn">import</span> <span class="n">inspect_response</span>


<span class="k">class</span> <span class="nc">LawsonSpider</span><span class="p">(</span><span class="n">BasePoiSpider</span><span class="p">):</span>
    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">parse_geo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="n">inspect_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">parse_store_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="o">...</span>
</code></pre></div>


<p>这样在执行到 <code>parse_geo</code> 时就会掉入 <code>shell</code> 界面，可以做进一步调试。</p>

<h4><code>crawl</code></h4>

<p>真正的抓取就是通过这个命令执行的：</p>

<div class="highlight"><pre><code class="sh"><span class="nv">$ </span>scrapy crawl store
</code></pre></div>




<div class="highlight"><pre><code class="text">2012-07-18 15:14:58+0800 [scrapy] INFO: Scrapy 0.14.4 started (bot: lawson)
2012-07-18 15:14:58+0800 [scrapy] DEBUG: Enabled extensions: FeedExporter, LogStats, TelnetConsole, CloseSpider, WebService, CoreStats, SpiderState
2012-07-18 15:14:58+0800 [scrapy] DEBUG: Enabled downloader middlewares: HttpAuthMiddleware, DownloadTimeoutMiddleware, UserAgentMiddleware, RetryMiddleware, DefaultHeadersMiddleware, RedirectMiddleware, CookiesMiddleware, HttpCompressionMiddleware, ChunkedTransferMiddleware, DownloaderStats
2012-07-18 15:14:58+0800 [scrapy] DEBUG: Enabled spider middlewares: HttpErrorMiddleware, OffsiteMiddleware, RefererMiddleware, UrlLengthMiddleware, DepthMiddleware
2012-07-18 15:14:58+0800 [scrapy] DEBUG: Enabled item pipelines:
2012-07-18 15:14:58+0800 [lawson] INFO: Spider opened
2012-07-18 15:14:58+0800 [lawson] INFO: Crawled 0 pages (at 0 pages/min), scraped 0 items (at 0 items/min)
2012-07-18 15:14:58+0800 [scrapy] DEBUG: Telnet console listening on 0.0.0.0:6023
2012-07-18 15:14:58+0800 [scrapy] DEBUG: Web service listening on 0.0.0.0:6080
2012-07-18 15:14:59+0800 [lawson] DEBUG: Crawled (200) &lt;GET http://www.lawson.com.cn/shops&gt; (referer: None)
2012-07-18 15:14:59+0800 [lawson] DEBUG: Crawled (200) &lt;GET http://www.lawson.com.cn/shops/list?area_id=16&gt; (referer: http://www.lawson.com.cn/shops)
2012-07-18 15:14:59+0800 [lawson] DEBUG: Scraped from &lt;200 http://www.lawson.com.cn/shops/list?area_id=16&gt;
    {&#39;address&#39;: u&#39;\u5609\u5b9a\u533a\u5609\u677e\u516c\u8def6128\u53f7&#39;,
     &#39;alias&#39;: u&#39;Lawson&#39;,
     &#39;branch&#39;: u&#39;\u540c\u6d4e\u5927\u5b66\u5e97&#39;,
     &#39;city&#39;: u&#39;\u4e0a\u6d77&#39;,
     &#39;district&#39;: u&#39;\u5609\u5b9a\u533a&#39;,
     &#39;name&#39;: u&#39;\u7f57\u68ee&#39;}
...
2012-07-18 15:15:01+0800 [lawson] DEBUG: Crawled (200) &lt;GET http://www.lawson.com.cn/shops/199/map&gt; (referer: http://www.lawson.com.cn/shops/list?area_id=12)
2012-07-18 15:15:01+0800 [lawson] DEBUG: Scraped from &lt;200 http://www.lawson.com.cn/shops/199/map&gt;
    {&#39;address&#39;: u&#39;\u677e\u6c5f\u533a\u897f\u6797\u5317\u8def1048\u53f7&#39;,
     &#39;alias&#39;: u&#39;Lawson&#39;,
     &#39;branch&#39;: u&#39;\u677e\u6c5f\u5987\u5e7c\u4fdd\u5065\u9662\u5e97&#39;,
     &#39;city&#39;: u&#39;\u4e0a\u6d77&#39;,
     &#39;district&#39;: u&#39;\u677e\u6c5f\u533a&#39;,
     &#39;latitude&#39;: u&#39;31.030622&#39;,
     &#39;longitude&#39;: u&#39;121.225586&#39;,
     &#39;name&#39;: u&#39;\u7f57\u68ee&#39;}
...
2012-07-18 15:15:21+0800 [lawson] INFO: Closing spider (finished)
2012-07-18 15:15:21+0800 [lawson] INFO: Stored csv feed (320 items) in: lawson_store.csv
2012-07-18 15:15:21+0800 [lawson] INFO: Dumping spider stats:
    {&#39;downloader/request_bytes&#39;: 158946,
     &#39;downloader/request_count&#39;: 309,
     &#39;downloader/request_method_count/GET&#39;: 309,
     &#39;downloader/response_bytes&#39;: 1883104,
     &#39;downloader/response_count&#39;: 309,
     &#39;downloader/response_status_count/200&#39;: 309,
     &#39;finish_reason&#39;: &#39;finished&#39;,
     &#39;finish_time&#39;: datetime.datetime(2012, 7, 18, 7, 15, 21, 905140),
     &#39;item_scraped_count&#39;: 320,
     &#39;request_depth_max&#39;: 2,
     &#39;scheduler/memory_enqueued&#39;: 309,
     &#39;start_time&#39;: datetime.datetime(2012, 7, 18, 7, 14, 58, 538838)}
2012-07-18 15:15:21+0800 [lawson] INFO: Spider closed (finished)
2012-07-18 15:15:21+0800 [scrapy] INFO: Dumping global stats:
    {}
</code></pre></div>


<p>从最后的报告中可以看到这个 spider 在一分钟内抓取了该网站全部320条数据
（<code>item_scraped_count</code>）。</p>

<p>若要输出抓取结果到一个文件，则加上参数：</p>

<div class="highlight"><pre><code class="sh">scrapy crawl store -o store.csv -t csv
</code></pre></div>


<p>这样，这篇 scrapy 使用教程的第一部分就结束了。</p>

  </section>
</article>

  
  
  
<article role="article" class="well">
  <header>
    <section class="title">
      <h1>
        
        <a href="/2012/06/time-machine-with-netatalk/">没有时间胶囊的时间机器</a>
        
      </h1>
    </section>
    <section class="meta">
      @<time>2012-06-26</time>
      <span class="categories">
        
        <em class="category">#linux</em>
        
        <em class="category">#apple</em>
        
        <em class="category">#server</em>
        
      </span>
    </section>
  </header>
  <section class="post">
    <p>Mac 有一个功能叫时间机器（Time
Machine），它能备份你硬盘上的所有数据到另一个硬盘或者是一个叫
<a href="http://www.apple.com/timecapsule/">时间胶囊（Time Capsule）</a> 的东西上。</p>

<p>时间胶囊很好，但是非常非常贵。而另一个办法则需要在 USB 上一直挂一个硬盘，这很麻
烦。两个办法都不能让我满意，而备份却是必不可少的。</p>

<p>于是我找到了 <a href="http://netatalk.sourceforge.net/">netatalk</a>。</p>

<p>这是一个跑在 *NIX 机器上的开源 <abbr title="AppleShare File Server">AFP</abbr>
服务器，它能像 Samba 之于 Windows 一样分享服务器上的文件，也可以将服务器上的一
个硬盘作为网络硬盘，发挥与时间胶囊相同的作用。要求则是一台 Linux/BSD 服务器。这
里我以 <a href="http://www.debian.org">Debian</a> 为例说下用法。</p>

<!-- more -->


<h2>安装</h2>

<h3>准备源</h3>

<p>要支持 OS X 10.7 Lion 就必须安装 2.2 以上的版本，在 Debian 中这个版本在
<code>wheezy</code> 的源中，若未启用 <code>wheezy</code> 则将下面两行加入 <code>/etc/apt/sources.list</code></p>

<div class="highlight"><pre><code class="text">deb http://mirrors.163.com/debian/ wheezy main contrib non-free
deb-src http://mirrors.163.com/debian/ wheezy main contrib non-free
</code></pre></div>


<h3>netatalk</h3>

<div class="highlight"><pre><code class="sh"><span class="nv">$ </span>apt-get update
<span class="nv">$ </span>apt-get install -t wheezy netatalk/wheezy libgcrypt11/wheezy
</code></pre></div>


<p>装 <code>wheezy</code> 中的 <code>libgcrypt11</code> 是因为 <code>netatalk</code> 打包的一个 bug——它默认依赖的
这个库的版本不对，会导致 <code>netatalk</code> crash。Miserable, I know。该 bug
<a href="http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=568601#30">已提交</a>。</p>

<h3>avahi</h3>

<p><code>avahi</code> 实现了 Apple 的 <code>Bonjour</code> 协议，可以让你的服务器直接出现在 Finder 侧边
栏，并可以让 Time Machine 自动找到对应的网络硬盘，省去每次备份前的手动挂载。</p>

<div class="highlight"><pre><code class="sh"><span class="nv">$ </span>apt-get install avahi-daemon
</code></pre></div>


<h2>配置</h2>

<h3>netatalk</h3>

<p>在 <code>/etc/netatalk/AppleVolumes.default</code> 末尾加上</p>

<div class="highlight"><pre><code class="text">&lt;path/to/backup/directory&gt; &quot;TimeMachine on $h&quot; allow:&lt;username&gt; cnidscheme:dbd options:upriv,usedots,tm
</code></pre></div>


<h3>avahi</h3>

<p>新建 <code>/etc/avahi/services/afpd.service</code></p>

<div class="highlight"><pre><code class="xml"><span class="cp">&lt;?xml version=&quot;1.0&quot; standalone=&#39;no&#39;?&gt;</span><span class="c">&lt;!--*-nxml-*--&gt;</span>
<span class="cp">&lt;!DOCTYPE service-group SYSTEM &quot;avahi-service.dtd&quot;&gt;</span>
<span class="nt">&lt;service-group&gt;</span>
  <span class="nt">&lt;name</span> <span class="na">replace-wildcards=</span><span class="s">&quot;yes&quot;</span><span class="nt">&gt;</span>%h<span class="nt">&lt;/name&gt;</span>
  <span class="nt">&lt;service&gt;</span>
    <span class="nt">&lt;type&gt;</span>_afpovertcp._tcp<span class="nt">&lt;/type&gt;</span>
    <span class="nt">&lt;port&gt;</span>548<span class="nt">&lt;/port&gt;</span>
  <span class="nt">&lt;/service&gt;</span>
  <span class="nt">&lt;service&gt;</span>
    <span class="nt">&lt;type&gt;</span>_device-info._tcp<span class="nt">&lt;/type&gt;</span>
    <span class="nt">&lt;port&gt;</span>0<span class="nt">&lt;/port&gt;</span>
    <span class="nt">&lt;txt-record&gt;</span>model=Xserve<span class="nt">&lt;/txt-record&gt;</span>
  <span class="nt">&lt;/service&gt;</span>
<span class="nt">&lt;/service-group&gt;</span>
</code></pre></div>


<h3>Time Machine</h3>

<p>Time Machine 默认不会显示 AFP 服务器上的网络硬盘，（在 Mac 上）改个参数让它显示
出来</p>

<div class="highlight"><pre><code class="sh"><span class="nv">$ </span>defaults write com.apple.systempreferences TMShowUnsupportedNetworkVolumes 1
</code></pre></div>


<h2>启动</h2>

<p>重启 <code>netatalk</code> 和 <code>avahi</code></p>

<div class="highlight"><pre><code class="sh"><span class="nv">$ </span>service netatalk restart
<span class="nv">$ </span>service avahi-daemon restart
</code></pre></div>


<p>这时候 Finder 中应该会出现服务器的图标，点击挂载（第一次需要，之后只要 <code>avahi</code>
开着 Time Machine 自己会找到）</p>

<p><img class="plain" src="http://pic.yupoo.com/kols_v/C4pgfYwD/14hgGk.png"
alt="Finder" /></p>

<p>打开 Time Machine，看到配置好的硬盘，选择即可</p>

<p><img class="plain" src="http://pic.yupoo.com/kols_v/C4pgfQEP/15D4b1.png" alt="Time Machine" /></p>

  </section>
</article>

  
  
  
<article role="article" class="well">
  <header>
    <section class="title">
      <h1>
        
        <a href="/2011/07/wordpress-dotcloud/">WordPress on dotCloud</a>
        
      </h1>
    </section>
    <section class="meta">
      @<time>2011-07-01</time>
      <span class="categories">
        
      </span>
    </section>
  </header>
  <section class="post">
    <p><a href="http://dotcloud.com">dotCloud</a> 是一个平台，或者是一个有人代为管理的服务器。它的主要用途是让人们免费的发布自己的
Web 应用，并且在其之上省去了管理服务器的工作，也就省去了相当的繁琐，使得发布应用更快速方便，并且使得 Developer
专注于应用，而不用为发布操太多心。想想那些名字，apache、nginx、php-fpm、uwsgi、SSL
等等等等，各种各样的各不相同的设置与调试只会让人觉得麻烦、不轻松，虽然这其中也有知识。 然而 dotCloud 的应用发布则相当简单：
（dotcloud 的 python
客户端安装及命令行基本使用方法请参考<a href="https://docs.dotcloud.com/">官方文档</a>，很简单。）</p>

<!-- more -->


<ol>
<li><p>新建 namespace。</p>

<pre><code>$ dotcloud create kdblue
</code></pre></li>
<li><p>建立 Build File。</p>

<pre><code>dotcloud.yml:

www:
  approot: blog
  type: php
  instances: 3
db:
  type: mysql
</code></pre>

<ul>
<li><code>www</code> 与 <code>db</code> 为 service 名称。</li>
<li><code>approot</code> 指定该 service 所在的本地根目录。</li>
<li><code>type</code> 指定应用类型（语言、服务器）。</li>
<li><code>instances</code> 设置进程数，若是 php 应用则会启动相应数量的 php-fpm 进程。</li>
</ul>
</li>
<li><p>将设置推送至服务器。</p>

<pre><code>$ dotcloud push kdblue .
</code></pre></li>
</ol>


<p>这样，一个名为 Build File 的 <code>dotcloud.yml</code> 文件就完成了所有服务器端的设置，简单并且轻量。 接下来的工作就是
WordPress
的自身设置，根据<a href="http://codex.wordpress.org/Installing_WordPress#Famous_5-Minute_Install">著名的5分钟安装</a>教程教我们的：</p>

<ol>
<li>搞到 WordPress。</li>
<li><p>在服务器上搞定数据库设置。</p>

<ol>
<li><p>首先获取 mysql 数据库密码及地址。</p>

<pre><code>$ dotcloud info kdblue.db
build_revision: rsync-1309344965.25
cluster: wolverine
config:
    hostname: kdblue-default-blog-db-0
    mysql_password: tpKsNbSjxXlb7I8DM3RH
created_at: 1309267100.7312429
ports:
-   name: ssh
    url: tcp://53e93k2c.dotcloud.com:9219
-   name: mysql
    url: tcp://53e93k2c.dotcloud.com:9220
state: running
type: mysql
</code></pre></li>
<li><p>登录并创建 WordPress 用数据库。</p>

<pre><code>$ dotcloud run kdblue.db -- mysql -u root -ptpKsNbSjxXlb7I8DM3RH
(Below in mysql shell)
&gt; create user 'dql' identified by 'password';
&gt; create database wordpress;
&gt; grant all on wordpress.* to 'dql'@'%'
  identified by 'password';
&gt; flush privileges;
</code></pre></li>
</ol>
</li>
<li><p>重命名 <code>wp-config-sample.php</code> 为 <code>wp-config.php</code>。</p></li>
<li><p>修改 <code>wp-config.php</code> 中的数据库设置。</p>

<pre><code>define('DB_NAME', 'blog');
define('DB_USER', 'dql');
define('DB_PASSWORD', 'password');
define('DB_HOST', '53e93k2c.dotcloud.com:9220');
</code></pre></li>
<li><p>确认一下文件树结构。</p>

<pre><code>  myapp/
  |- dotcloud.yml
  |_ blog/
     |_ wordpress/
         |_ wp-config.php
         |_ wp-contents/
         |_ ...
</code></pre></li>
<li><p>将设置完毕的 WordPress 推送至服务器并重启进程。</p>

<pre><code>$ dotcloud push kdblue .
$ dotcloud restart kdblue.www
</code></pre>

<p>至此 WordPress 便部署成功，访问
<code>http://53e93k2c.dotcloud.com/wordpress/wp-admin/install</code> 即可完成安装。</p></li>
<li><p>有域名的可以设置自定义域名，并按说明更改相应 DNS 设置。</p>

<pre><code>$ dotcloud alias add kdblue.www www.example.com
</code></pre></li>
</ol>


<p>之后是一些有用的 Tip。</p>

<ul>
<li><p>因为每次 <code>push</code> 都会将服务器端的更改删除（例如安装插件），因此可以使用一个 Post-Install Hook 来避免。</p>

<pre><code>#!/bin/sh
if [ -d ~/data/wp-content ]
then
      rm -rf ~/current/wordpress/wp-content
else
      mkdir -p ~/data
      mv ~/current/wordpress/wp-content ~/data/wp-content
fi
ln -s ~/data/wp-content ~/current/wordpress/wp-content
</code></pre>

<p>将此文件命名为 <code>postinstall</code> 加上执行权限后放在 <code>approot</code> 目录下，这样每次 <code>push</code>
后之前网页端所做的更改都会保留。（但升级 WordPress 本体似乎必须在本地执行后推送）</p></li>
<li><p>若要直接在域名处（<code>www.example.com</code>）而非子目录处（<code>www.example.com/wordpress</code>）显示
WordPress，则需要自定义一项 nginx 设置。</p>

<pre><code>try_files $uri $uri/ /index.php;
</code></pre>

<p>保存为 <code>nginx.conf</code> 后放在 <code>approot</code> 目录中。</p></li>
<li><p><a href="http://www.wwwizer.com/">wwwizer</a> 可以免费将 dotcloud 不支持的 naked domain
301重定向到前缀 www 的子域名，免费且不用注册，直接 A 记录指向其提供的 IP 即可。</p></li>
</ul>


  </section>
</article>

  
  <div class="more-archive">
    
    <a href="/archive.html"><div class="circle">&nbsp;</div></a>
    
  </div>
</div>

      </div>
      <footer role="contentinfo" class="contentinfo">
        <div>
  
  
  <span class="copy">&copy; 2004-2013 kane</span>
  |
  <span class="license">
    <a href="http://creativecommons.org/licenses/by/3.0/cn/">license</a>
  </span>
  |
  <span class="engine">
    powered by <a href="http://jekyllrb.com/">jekyll</a> & <a href="http://compass-style.org">compass</a>
  </span>
</div>

      </footer>
    </div>
  </body>
</html>
