<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <!--<link rel="stylesheet" href="/vendor/bootstrap/css/bootstrap.css" />-->
    <link rel="stylesheet" href="/assets/stylesheets/screen.css" />
    <link rel="stylesheet" href="/assets/stylesheets/syntax.css" />
    <script type="text/javascript" src="/vendor/bootstrap/js/bootstrap.js"></script>
    <title>
      没有时间胶囊的时间机器 | kanedou.me
    </title>
  </head>
  <body>
    <div class="container">
      <header>
        <div class="row">
          <section class="site-name">
            <div class="span2">
              <h1><a href="/">kanedou.me</a></h1>
            </div>
          </section>
          <section class="nav">
            <div class="span4">
              <nav role="navigation">
  <ul class="nav nav-pills">
    <li><a href="/archive.html">archive</a></li>
    <li><a href="/links.html">links</a></li>
    <li><a href="/about.html">about</a></li>
  </ul>
</nav>

            </div>
          </section>
        </div>
      </header>
      <div id="content">
        
<article role="article" class="well">
  <header>
    <section class="title">
      <h1>
        
        没有时间胶囊的时间机器
        
      </h1>
    </section>
    <section class="meta">
      @<time>2012-06-26</time>
      <span class="categories">
        
        <em class="category">#linux</em>
        
        <em class="category">#apple</em>
        
        <em class="category">#server</em>
        
      </span>
    </section>
  </header>
  <section class="post">
    <p>Mac 有一个功能叫时间机器（Time
Machine），它能备份你硬盘上的所有数据到另一个硬盘或者是一个叫
<a href="http://www.apple.com/timecapsule/">时间胶囊（Time Capsule）</a> 的东西上。</p>

<p>时间胶囊很好，但是非常非常贵。而另一个办法则需要在 USB 上一直挂一个硬盘，这很麻
烦。两个办法都不能让我满意，而备份却是必不可少的。</p>

<p>于是我找到了 <a href="http://netatalk.sourceforge.net/">netatalk</a>。</p>

<p>这是一个跑在 *NIX 机器上的开源 <abbr title="AppleShare File Server">AFP</abbr>
服务器，它能像 Samba 之于 Windows 一样分享服务器上的文件，也可以将服务器上的一
个硬盘作为网络硬盘，发挥与时间胶囊相同的作用。要求则是一台 Linux/BSD 服务器。这
里我以 <a href="http://www.debian.org">Debian</a> 为例说下用法。</p>

<!-- more -->


<h2>安装</h2>

<h3>准备源</h3>

<p>要支持 OS X 10.7 Lion 就必须安装 2.2 以上的版本，在 Debian 中这个版本在
<code>wheezy</code> 的源中，若未启用 <code>wheezy</code> 则将下面两行加入 <code>/etc/apt/sources.list</code></p>

<div class="highlight"><pre><code class="text">deb http://mirrors.163.com/debian/ wheezy main contrib non-free
deb-src http://mirrors.163.com/debian/ wheezy main contrib non-free
</code></pre></div>


<h3>netatalk</h3>

<div class="highlight"><pre><code class="sh"><span class="nv">$ </span>apt-get update
<span class="nv">$ </span>apt-get install -t wheezy netatalk/wheezy libgcrypt11/wheezy
</code></pre></div>


<p>装 <code>wheezy</code> 中的 <code>libgcrypt11</code> 是因为 <code>netatalk</code> 打包的一个 bug——它默认依赖的
这个库的版本不对，会导致 <code>netatalk</code> crash。Miserable, I know。该 bug
<a href="http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=568601#30">已提交</a>。</p>

<h3>avahi</h3>

<p><code>avahi</code> 实现了 Apple 的 <code>Bonjour</code> 协议，可以让你的服务器直接出现在 Finder 侧边
栏，并可以让 Time Machine 自动找到对应的网络硬盘，省去每次备份前的手动挂载。</p>

<div class="highlight"><pre><code class="sh"><span class="nv">$ </span>apt-get install avahi-daemon
</code></pre></div>


<h2>配置</h2>

<h3>netatalk</h3>

<p>在 <code>/etc/netatalk/AppleVolumes.default</code> 末尾加上</p>

<div class="highlight"><pre><code class="text">&lt;path/to/backup/directory&gt; &quot;TimeMachine on $h&quot; allow:&lt;username&gt; cnidscheme:dbd options:upriv,usedots,tm
</code></pre></div>


<h3>avahi</h3>

<p>新建 <code>/etc/avahi/services/afpd.service</code></p>

<div class="highlight"><pre><code class="xml"><span class="cp">&lt;?xml version=&quot;1.0&quot; standalone=&#39;no&#39;?&gt;</span><span class="c">&lt;!--*-nxml-*--&gt;</span>
<span class="cp">&lt;!DOCTYPE service-group SYSTEM &quot;avahi-service.dtd&quot;&gt;</span>
<span class="nt">&lt;service-group&gt;</span>
  <span class="nt">&lt;name</span> <span class="na">replace-wildcards=</span><span class="s">&quot;yes&quot;</span><span class="nt">&gt;</span>%h<span class="nt">&lt;/name&gt;</span>
  <span class="nt">&lt;service&gt;</span>
    <span class="nt">&lt;type&gt;</span>_afpovertcp._tcp<span class="nt">&lt;/type&gt;</span>
    <span class="nt">&lt;port&gt;</span>548<span class="nt">&lt;/port&gt;</span>
  <span class="nt">&lt;/service&gt;</span>
  <span class="nt">&lt;service&gt;</span>
    <span class="nt">&lt;type&gt;</span>_device-info._tcp<span class="nt">&lt;/type&gt;</span>
    <span class="nt">&lt;port&gt;</span>0<span class="nt">&lt;/port&gt;</span>
    <span class="nt">&lt;txt-record&gt;</span>model=Xserve<span class="nt">&lt;/txt-record&gt;</span>
  <span class="nt">&lt;/service&gt;</span>
<span class="nt">&lt;/service-group&gt;</span>
</code></pre></div>


<h3>Time Machine</h3>

<p>Time Machine 默认不会显示 AFP 服务器上的网络硬盘，（在 Mac 上）改个参数让它显示
出来</p>

<div class="highlight"><pre><code class="sh"><span class="nv">$ </span>defaults write com.apple.systempreferences TMShowUnsupportedNetworkVolumes 1
</code></pre></div>


<h2>启动</h2>

<p>重启 <code>netatalk</code> 和 <code>avahi</code></p>

<div class="highlight"><pre><code class="sh"><span class="nv">$ </span>service netatalk restart
<span class="nv">$ </span>service avahi-daemon restart
</code></pre></div>


<p>这时候 Finder 中应该会出现服务器的图标，点击挂载（第一次需要，之后只要 <code>avahi</code>
开着 Time Machine 自己会找到）</p>

<p><img class="plain" src="http://pic.yupoo.com/kols_v/C4pgfYwD/14hgGk.png"
alt="Finder" /></p>

<p>打开 Time Machine，看到配置好的硬盘，选择即可</p>

<p><img class="plain" src="http://pic.yupoo.com/kols_v/C4pgfQEP/15D4b1.png" alt="Time Machine" /></p>

  </section>
</article>


<section class="comments well">
  <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'kdblue'; // required: replace example with your forum shortname
    var disqus_identifier = 'http://kanedou.me/2012/06/time-machine-with-netatalk/';
    var disqus_url = 'http://kanedou.me/2012/06/time-machine-with-netatalk/';
    var disqus_script = 'embed.js';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

</section>



      </div>
      <footer role="contentinfo" class="contentinfo">
        <div>
  
  
  <span class="copy">&copy; 2004-2012 kane</span>
  |
  <span class="license">
    <a href="http://creativecommons.org/licenses/by/3.0/cn/">license</a>
  </span>
  |
  <span class="engine">
    powered by <a href="http://jekyllrb.com/">jekyll</a> & <a href="http://compass-style.org">compass</a>
  </span>
</div>

      </footer>
    </div>
  </body>
</html>
